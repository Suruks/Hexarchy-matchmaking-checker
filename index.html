<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Queue Checker Live</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #f0f0f0;
  }
  #status {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 10px;
  }
  #lastCheck {
    font-size: 14px;
    color: #555;
    margin-bottom: 20px;
  }
  .black { color: black; }
  .green { color: darkgreen; }
  .red { color: darkred; white-space: pre-wrap; }
  label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    margin-bottom: 6px;
  }
</style>
</head>
<body>

<div id="status">Loading...</div>
<div id="lastCheck">Last check: —</div>

<label>
  <input type="checkbox" id="notifyToggle">
  Enable notifications
</label>

<label>
  <input type="checkbox" id="soundToggle">
  Enable sound
</label>

<audio id="alertSound" src="alert.mp3" preload="auto"></audio>

<script>
const URL = 'https://your-worker-name.username.workers.dev'; // ← ваш Cloudflare Worker URL

const statusEl = document.getElementById('status');
const lastCheckEl = document.getElementById('lastCheck');
const notifyToggle = document.getElementById('notifyToggle');
const soundToggle = document.getElementById('soundToggle');
const alertSound = document.getElementById('alertSound');

let previousOpenGames = null;
let intervalId;
let notificationsEnabled = false;
let soundEnabled = false;

// --- Notifications ---
async function requestNotificationPermission() {
  if (!('Notification' in window)) return false;
  const permission = await Notification.requestPermission();
  return permission === 'granted';
}

function sendNotification(title, body) {
  if (notificationsEnabled && Notification.permission === 'granted') {
    new Notification(title, { body, icon: 'https://match.maintankservers.com/favicon.ico' });
  }
  if (soundEnabled) {
    alertSound.currentTime = 0;
    alertSound.play();
  }
}

// --- Queue check ---
async function checkQueue() {
  try {
    const res = await fetch(URL);
    if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
    const data = await res.json();

    const now = new Date();
    lastCheckEl.textContent = `Last check: ${now.toLocaleString()}`;

    if (data.openGames === 0) {
      statusEl.textContent = 'Patience… challengers will appear.';
      statusEl.className = 'black';
      document.title = 'Queue Checker Live';
    } else if (data.openGames > 0) {
      statusEl.textContent = 'Players are looking for a game!';
      statusEl.className = 'green';
      document.title = 'Match found!';
    } else {
      statusEl.textContent = JSON.stringify(data, null, 2);
      statusEl.className = 'red';
      document.title = 'Queue Checker Live';
    }

    // уведомление только при изменении с "0" → ">0"
    if (previousOpenGames !== null && previousOpenGames === 0 && data.openGames > 0) {
      sendNotification('Hexarchy — Match found!', 'Players are looking for a game!');
    }

    previousOpenGames = data.openGames;

  } catch (err) {
    lastCheckEl.textContent = `Last check: ${new Date().toLocaleString()}`;
    statusEl.textContent = 'Network error: ' + err;
    statusEl.className = 'red';
  }
}

// --- Auto refresh ---
function startLiveCheck() {
  checkQueue();
  intervalId = setInterval(checkQueue, 5000);
}

function stopLiveCheck() {
  clearInterval(intervalId);
}

// --- Toggle handlers ---
notifyToggle.addEventListener('change', async () => {
  if (notifyToggle.checked) {
    const granted = await requestNotificationPermission();
    notificationsEnabled = granted;
    if (!granted) {
      alert('Notifications are blocked in your browser settings.');
      notifyToggle.checked = false;
    }
  } else {
    notificationsEnabled = false;
  }
});

soundToggle.addEventListener('change', () => {
  soundEnabled = soundToggle.checked;
});

// --- Start ---
startLiveCheck();
</script>

</body>
</html>
